@using TheNextLevel.Application.DTOs
@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Presentation.Components.Buttons
@inject ITaskService TaskService

<div class="task-card @(IsCompleted ? "completed" : "")" @onclick:stopPropagation="true">
    <div class="task-actions">
        <ContextMenuButton OnMenuClick="OnMenuClick"
                           OnEditClick="OnEditClick"
                           OnAssignToProjectClick="OnAssignToProjectClick"
                           OnDeleteClick="OnDeleteClick" />
    </div>
    <div class="task-checkbox-container">
        <input class="task-checkbox" type="checkbox" checked="@IsCompleted" @onchange="OnStatusChange">
        <div class="task-details">
            <div class="task-title @(IsCompleted ? "completed" : "")">@(Task?.Name ?? "Untitled")</div>
            @if (!string.IsNullOrEmpty(Task?.Description))
            {
                <div class="task-description">@Task.Description</div>
            }
            <div class="task-meta">
                <span class="task-status">@(Task?.IsCompleted == true ? "Completed" : "Pending")</span>
            </div>
        </div>
    </div>
</div>

@code 
{
    [Parameter]
    public TaskDto? Task { get; set; }
    
    [Parameter]
    public EventCallback<TaskDto> OnTaskUpdated { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnTaskEdit { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnTaskAssignToProject { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnTaskDeleteRequest { get; set; }

    private bool IsCompleted => Task?.IsCompleted == true;
    private bool showMenu = false;

    private async Task OnStatusChange(ChangeEventArgs e)
    {
        if (Task == null) return;
        
        var isChecked = (bool)(e.Value ?? false);
        
        if (isChecked && !IsCompleted)
        {
            await TaskService.CompleteTaskAsync(Task.Id);
        }
        else if (!isChecked && IsCompleted)
        {
            await TaskService.ReopenTaskAsync(Task.Id);
        }
        
        // Refresh task data and notify parent
        var updatedTask = await TaskService.GetTaskByIdAsync(Task.Id);
        if (updatedTask != null)
        {
            await OnTaskUpdated.InvokeAsync(updatedTask);
        }
    }
    
    private void OnMenuClick()
    {
        showMenu = !showMenu;
    }

    private async Task OnEditClick()
    {
        showMenu = false;
        if (Task != null)
        {
            await OnTaskEdit.InvokeAsync(Task);
        }
    }

    private async Task OnAssignToProjectClick()
    {
        showMenu = false;
        if (Task != null)
        {
            await OnTaskAssignToProject.InvokeAsync(Task);
        }
    }

    private async Task OnDeleteClick()
    {
        showMenu = false;
        if (Task != null)
        {
            await OnTaskDeleteRequest.InvokeAsync(Task);
        }
    }
}
