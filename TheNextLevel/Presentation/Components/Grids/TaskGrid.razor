@using Microsoft.AspNetCore.Components.Web.Virtualization
@using TheNextLevel.Application.DTOs
@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Presentation.Components.Cards
@using TheNextLevel.Presentation.Dialogs

@inject ITaskService TaskService

@if (_isLoading)
{
    <div class="loading-indicator">Loading tasks...</div>
}
else
{
    <div class="filter-controls controls-container">
        <div class="buttons-group">
            <button class="filter-btn @(_showCompleted ? "" : "active")" @onclick="ShowPending">
                Active
            </button>
            <button class="filter-btn @(_showCompleted ? "active" : "")" @onclick="ShowCompleted">
                Completed
            </button>
        </div>
        <div class="add-task-container">
            <button class="filter-btn" @onclick="OpenAddTaskDialog">
                Add New Task ‚ûï
            </button>
        </div>        
    </div>        
}

<div class="@(_totalCount > 0 ? "task-grid" : "")" tabindex="-1">
    <Virtualize ItemsProvider="LoadTasksProvider" @ref="_virtualizeComponent" Context="task">
        <ItemContent>
            <TaskCard
                Task="task"
                Project="Project"
                OnEditRequested="OpenEditDialog"
                OnDeleteRequested="OpenDeleteDialog" />
        </ItemContent>
        <Placeholder>
            <div class="loading-card">Loading...</div>
        </Placeholder>
        <EmptyContent>
            <div class="empty-state">
                @if (Project == null)
                {
                    <div class="empty-icon">üìÅ</div>
                    <p class="empty-title">No project selected</p>
                    <p class="empty-subtitle">Please select a project to view its tasks</p>
                }
                else if (_showCompleted)
                {
                    <div class="empty-icon">‚úì</div>
                    <p class="empty-title">No completed tasks yet</p>
                    <p class="empty-subtitle">Tasks you complete will appear here</p>
                }
                else
                {
                    <div class="empty-icon">üéØ</div>
                    <p class="empty-title">No active tasks</p>
                    <p class="empty-subtitle">You're all caught up! Time to add something new?</p>
                }
            </div>
        </EmptyContent>
    </Virtualize>
</div>

<NewTaskDialog
    @ref="_newTaskDialog"
    IsVisible="@_showNewTaskDialog"
    OnCancel="CloseNewTaskDialog"
    OnResult="HandleTaskCreated" />

<EditTaskDialog
    Task="@_selectedTask"
    IsVisible="@_showEditDialog"
    OnClose="CloseEditDialog"
    OnTaskSaved="HandleTaskUpdated" />

<ConfirmDeleteDialog
    IsVisible="@_showDeleteDialog"
    OnCancel="CloseDeleteDialog"
    OnConfirm="HandleDeleteConfirmed"
    ItemName="@(_selectedTask?.Name ?? "this task")"
    ItemType="Task" />

@code {
    [Parameter]
    public ProjectDto? Project { get; set; }

    private NewTaskDialog? _newTaskDialog;
    private Virtualize<TaskDto>? _virtualizeComponent;
    private TaskDto? _selectedTask;
    private bool _isLoading = false;

    // Dialog visibility flags
    private bool _showNewTaskDialog;
    private bool _showEditDialog;
    private bool _showDeleteDialog;

    // Filter state
    private bool _showCompleted;
    private int _totalCount;

    protected override Task OnInitializedAsync()
    {
        _isLoading = true;
        return base.OnInitializedAsync();
    }

    private async ValueTask<ItemsProviderResult<TaskDto>> LoadTasksProvider(ItemsProviderRequest request)
    {
        if (Project == null)
        {
            return new ItemsProviderResult<TaskDto>(
                Array.Empty<TaskDto>(),
                0);
        }

        try
        {
            _isLoading = true;
            
            var pagedResult = await TaskService.ListByProjectAsync(
                projectId: Project.Id,
                skip: request.StartIndex,
                take: request.Count,
                isCompleted: _showCompleted);

            _totalCount = pagedResult.TotalCount;

            _isLoading = false;

            StateHasChanged();

            return new ItemsProviderResult<TaskDto>(
                pagedResult.Items,
                pagedResult.TotalCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
            return new ItemsProviderResult<TaskDto>(
                Array.Empty<TaskDto>(),
                0);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // === FILTER CONTROLS ===
    private async Task ShowPending()
    {
        _showCompleted = false;
        await RefreshList();
    }

    private async Task ShowCompleted()
    {
        _showCompleted = true;
        await RefreshList();
    }

    // === OPEN DIALOGS ===
    private void OpenAddTaskDialog()
    {
        _showNewTaskDialog = true;
        StateHasChanged();
    }

    private void OpenEditDialog(TaskDto task)
    {
        _selectedTask = task;
        _showEditDialog = true;
        StateHasChanged();
    }

    private void OpenDeleteDialog(TaskDto task)
    {
        _selectedTask = task;
        _showDeleteDialog = true;
        StateHasChanged();
    }

    // === CLOSE DIALOGS ===
    private void CloseNewTaskDialog()
    {
        _showNewTaskDialog = false;
        StateHasChanged();
    }

    private void CloseEditDialog()
    {
        _showEditDialog = false;
        _selectedTask = null;
        StateHasChanged();
    }

    private void CloseDeleteDialog()
    {
        _showDeleteDialog = false;
        _selectedTask = null;
        StateHasChanged();
    }

    // === HANDLE RESULTS ===
    private async Task HandleTaskCreated(TaskDto task)
    {
        _showNewTaskDialog = false;

        if (task != null && task.ProjectId != Project?.Id)
        {
            await TaskService.AssignAsync(task.Id, Project?.Id);
        }

        await RefreshList();
    }

    private async Task HandleTaskUpdated(TaskDto task)
    {
        _showEditDialog = false;
        _selectedTask = null;
        await RefreshList();
    }

    private async Task HandleDeleteConfirmed()
    {
        if (_selectedTask != null)
        {
            await TaskService.DeleteAsync(_selectedTask.Id);
        }

        _showDeleteDialog = false;
        _selectedTask = null;
        await RefreshList();
    }

    // === PUBLIC METHODS ===
    public async Task RefreshList()
    {
        if (_virtualizeComponent != null)
        {
            await _virtualizeComponent.RefreshDataAsync();
        }
        StateHasChanged();
    }
}