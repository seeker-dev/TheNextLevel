# Turso Database Integration Guide

This guide explains how to connect your .NET MAUI application to Turso databases.

## Overview

The application now supports two database modes:
- **EFCore**: Uses Entity Framework Core with SQLite or SQL Server
- **Turso**: Uses Turso's HTTP API for cloud-hosted libSQL databases

## Files Created

### Configuration
- `Infrastructure/Configuration/TursoConfiguration.cs` - Configuration model for Turso settings

### Data Access
- `Infrastructure/Data/TursoClient.cs` - HTTP client wrapper for Turso's `/v2/pipeline` API
- `Infrastructure/Repositories/TursoTaskRepository.cs` - Task repository implementation using Turso
- `Infrastructure/Repositories/TursoProjectRepository.cs` - Project repository implementation using Turso

### Updated Files
- `MauiProgram.cs` - Added Turso mode implementation and repository registration
- `appsettings.example.json` - Added Turso configuration examples

## Configuration

### 1. Get Your Turso Credentials

First, you need to get your database URL and authentication token from Turso:

```bash
# Get your database URL (it will be in format: libsql://your-db-your-org.turso.io)
turso db show your-database-name

# Generate an authentication token
turso db tokens create your-database-name
```

### 2. Update appsettings.json

Update your `appsettings.json` file with Turso credentials:

```json
{
  "DatabaseMode": "Turso",
  "Turso": {
    "DatabaseUrl": "https://your-database-your-org.turso.io",
    "AuthToken": "your-actual-auth-token-here"
  }
}
```

**Important Notes:**
- Replace `libsql://` with `https://` in the database URL
- The auth token is a JWT token generated by the Turso CLI
- Keep your auth token secure - don't commit it to source control

## Database Schema

Your Turso database should have the following tables already set up:

### Tasks Table
```sql
CREATE TABLE Tasks (
    Id TEXT PRIMARY KEY,
    Title TEXT NOT NULL,
    Description TEXT NOT NULL,
    IsCompleted INTEGER NOT NULL,
    CreatedAt TEXT NOT NULL,
    ProjectId TEXT
);
```

### Projects Table
```sql
CREATE TABLE Projects (
    Id TEXT PRIMARY KEY,
    Name TEXT NOT NULL,
    Description TEXT,
    CreatedAt TEXT NOT NULL
);
```

## How It Works

### Architecture

1. **TursoClient**: Wraps Turso's HTTP API
   - Handles authentication with Bearer tokens
   - Supports parameterized queries
   - Implements batch transactions
   - Parses JSON responses into strongly-typed models

2. **Repository Pattern**: `TursoTaskRepository` and `TursoProjectRepository`
   - Implement the same `ITaskRepository` and `IProjectRepository` interfaces as EF Core versions
   - Convert entities to/from SQL queries
   - Map JSON results to entity objects

3. **Service Layer**: No changes required
   - Services work with repository interfaces
   - Completely agnostic to data access implementation

### API Endpoints Used

- `POST /v2/pipeline` - Main endpoint for executing SQL queries
- Supports:
  - Parameterized queries (positional with `?`)
  - Batch transactions
  - Multiple statement execution

### Data Type Mapping

| C# Type | Turso Type | Storage |
|---------|------------|---------|
| Guid | text | string |
| string | text | string |
| bool | integer | 0 or 1 |
| DateTime | text | ISO 8601 format |
| int/long | integer | number |

## Switching Between Database Modes

Simply change the `DatabaseMode` setting in `appsettings.json`:

```json
// Use Turso
"DatabaseMode": "Turso"

// Use EF Core with SQLite or SQL Server
"DatabaseMode": "EFCore"
```

## Important Limitations

1. **No Migrations**: Turso mode doesn't use EF Core migrations. You must set up your schema manually in Turso.

2. **Transaction Timeouts**:
   - Transactions have a 5-second completion window
   - Connections close after 10 seconds of inactivity

3. **Stateless API**:
   - No interactive transactions (BEGIN/COMMIT/ROLLBACK)
   - All statements in a batch execute as a single transaction

4. **No Navigation Property Loading**:
   - Tasks are loaded separately for each project
   - No automatic eager/lazy loading like EF Core

## Testing the Integration

1. Update your `appsettings.json` with valid Turso credentials
2. Ensure your Turso database has the correct schema
3. Change `DatabaseMode` to `"Turso"`
4. Run the application
5. The app should connect to your Turso database and work identically to the EF Core version

## Troubleshooting

### Connection Errors
- Verify your database URL format: `https://[db]-[org].turso.io`
- Check that your auth token is valid and not expired
- Ensure your database is accessible (not paused or deleted)

### Query Errors
- Check that your database schema matches the expected structure
- Verify column names match exactly (case-sensitive)
- Look at the error messages in the Turso response

### Null Reference Warnings
- The code handles null values properly with `DBNull.Value`
- Nullable ProjectId fields are supported

## Security Best Practices

1. **Never commit credentials**: Use environment variables or secure storage
2. **Rotate tokens regularly**: Generate new auth tokens periodically
3. **Use separate databases**: Different databases for dev/staging/production
4. **Limit token scope**: Use database-specific tokens when possible

## Performance Considerations

1. **Batch Operations**: The client supports batch transactions for better performance
2. **Connection Pooling**: HttpClient is registered as a singleton
3. **Lazy Loading**: Projects load their tasks separately (could be optimized with batch queries)

## Future Enhancements

Potential improvements you could add:

1. **Query Batching**: Combine multiple queries into single requests
2. **Caching**: Add response caching for frequently accessed data
3. **Retry Logic**: Implement automatic retry for transient failures
4. **Connection Resilience**: Add exponential backoff for rate limiting
5. **Query Optimization**: Use SQL joins instead of separate queries for related data
