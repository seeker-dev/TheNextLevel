@using TheNextLevel.Application.DTOs
@using TheNextLevel.Application.Interfaces
@using System.Text.Json
@inject ITaskService TaskService
@inject NavigationManager Navigation

<div class="task-card @(_isCompleted ? "completed" : "")" style="cursor: pointer;">
    <div class="task-checkbox-container">
        <input class="task-checkbox" type="checkbox" checked="@_isCompleted" @onchange="OnStatusChange">
        <div class="task-details">
            <div class="task-title @(_isCompleted ? "completed" : "")" @onclick="NavigateToDetail" @onclick:stopPropagation="true">@(Task?.Name ?? "Untitled")</div>
            @if (!string.IsNullOrEmpty(Task?.Description))
            {
                <div class="task-description">@Task.Description</div>
            }
            <div class="task-meta">
                <span class="task-status">@(_isCompleted ? "Completed" : "Active")</span>
            </div>
        </div>
        @if (_editEnabled || _deleteEnabled)
        {
            <div class="task-card-actions">
                @if (_editEnabled)
                {
                    <button class="action-btn" title="Edit Task" @onclick="RequestEdit" @onclick:stopPropagation="true">‚úèÔ∏è</button>
                }
                @if (_deleteEnabled)
                {
                    <button class="action-btn action-btn-danger" title="Delete Task" @onclick="RequestDelete" @onclick:stopPropagation="true">üóëÔ∏è</button>
                }
            </div>
        }
    </div>
</div>

@code
{
    [Parameter]
    public TaskDto? Task { get; set; }

    [Parameter]
    public ProjectDto? Project { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnEditRequested { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnDeleteRequested { get; set; }

    private bool _editEnabled => OnEditRequested.HasDelegate;

    private bool _deleteEnabled => OnDeleteRequested.HasDelegate;

    private bool _isCompleted => Task?.IsCompleted == true;

    private bool _isSubtask => Task?.ParentTaskId != null;

    private async Task RequestEdit()
    {
        if (Task != null)
            await OnEditRequested.InvokeAsync(Task);
    }

    private async Task RequestDelete()
    {
        if (Task != null)
            await OnDeleteRequested.InvokeAsync(Task);
    }

    private async Task OnStatusChange(ChangeEventArgs e)
    {
        if (Task == null) return;

        var isChecked = (bool)(e.Value ?? false);

        if (isChecked && !_isCompleted)
        {
            await TaskService.CompleteAsync(Task.Id);
        }
        else if (!isChecked && _isCompleted)
        {
            await TaskService.ResetAsync(Task.Id);
        }

        StateHasChanged();

        //Task.IsCompleted = isChecked;
    }

    private void NavigateToDetail()
    {
        if (Task != null && Project != null && !_isSubtask)
        {
            var projectJson = JsonSerializer.Serialize(Project);
            Navigation.NavigateTo($"/task/{Task.Id}",
                new NavigationOptions
                {
                    HistoryEntryState = projectJson
                });
        }
    }
}
