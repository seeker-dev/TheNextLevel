@page "/missions/{Id:int}"
@using TheNextLevel.Presentation.Components.Buttons
@using TheNextLevel.Presentation.Dialogs
@using TheNextLevel.Presentation.Components.Grids
@inject IMissionService MissionService
@inject IProjectService ProjectService
@inject NavigationManager NavigationManager

<main class="main-content">
    <div class="mission-page-header custom-bg">
        <button class="back-button" @onclick="NavigateBack">‚Üê</button>
        @if (_isLoading)
        {
            <p class="loading-text">Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_mission != null)
        {
            <h1 class="mission-page-title">@_mission.Name</h1>
            
            <div class="mission-action-buttons">
                <button title="Edit Mission" tooltip="Edit Mission" class="action-btn action-btn-primary" @onclick="ShowEditDialog">‚úèÔ∏è</button>
                <button title="Delete Mission" tooltip="Delete Mission" class="action-btn action-btn-danger" @onclick="ShowDeleteDialog">üóëÔ∏è</button>
                <button class="action-btn action-btn-primary" @onclick="OpenNewProjectDialog">
                    Add New Project ‚ûï
                </button>
            </div>
        }
    </div>
    <div class="description-section">
        @if (_isLoading)
        {
            <p class="loading-text">Loading mission description...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_mission != null)
        {
            <h3>Description</h3>
            <p>@_mission.Description</p>
        }
    </div>
    <div class="projects-section">
        @if (_isLoading)
        {
            <p class="loading-text">Loading projects...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_mission != null)
        {
            <ProjectList
                @ref="_projectList"
                Mission="@_mission"/>
        }
    </div>
</main>

<EditModal 
    Item="@_mission"
    @ref="_editModal"
    OnResult="HandleMissionEdited"
    OnCancel="HideEditDialog" />

<ConfirmDeleteDialog
    IsVisible="@_isDeleteDialogVisible"
    ItemName="@_mission?.Name"
    ItemType="mission"
    OnCancel="() => _isDeleteDialogVisible = false"
    OnConfirm="OnDeleteConfirmed" />

<NewProjectDialog
    @ref="_newProjectDialog"
    IsVisible="_showNewProjectDialog"
    ExistingProject="_editingProject"
    Mission="@_mission"
    OnResult="HandleProjectSaved"
    OnCancel="CloseNewProjectDialog" />

@code {
    [Parameter]
    public int Id { get; set; }
    private MissionDto? _mission;
    private bool _isLoading = true;
    private string? _errorMessage;
    private bool _isDeleteDialogVisible = false;

    private EditModal? _editModal;
    private NewProjectDialog? _newProjectDialog;
    private ProjectList? _projectList;

    private bool _showNewProjectDialog = false;
    private ProjectDto? _editingProject = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadMissionAsync();
    }

    private async Task LoadMissionAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _mission = await MissionService.GetByIdAsync(Id);

            if (_mission == null)
            {
                _errorMessage = "Mission not found.";
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading mission: {ex.Message}");
            _errorMessage = "Failed to load mission. Please try again later.";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/missions");
    }

    private void ShowDeleteDialog()
    {
        _isDeleteDialogVisible = true;
    }

    private void ShowEditDialog()
    {
        _editModal?.ShowDialog();
    }

    private void HideEditDialog()
    {
        _editModal?.HideDialog();
    }

    private void HandleMissionEdited(IItemDto? updatedMission)
    {
        if (updatedMission is MissionDto missionDto)
        {
            _mission = missionDto;
            StateHasChanged();
        }
    }

    private async Task OnDeleteConfirmed()
    {
        var result = await ProjectService.ListByMissionAsync(Id, 0, 1);
        // if there are projects in this mission, block deletion and show error message
        if (_mission != null && result.Items.Any())
        {
            _errorMessage = "Cannot delete mission with existing projects. Please remove or reassign projects before deleting.";
            _isDeleteDialogVisible = false;
            StateHasChanged();
            return;
        }

        try
        {
            if (_mission != null)
            {
                await MissionService.DeleteAsync(_mission.Id);
                NavigationManager.NavigateTo("/missions");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting mission: {ex.Message}");
            _errorMessage = "Failed to delete mission. Please try again later.";
        }
        finally
        {
            _isDeleteDialogVisible = false;
            StateHasChanged();
        }
    }

    private void OpenNewProjectDialog()
    {
        _editingProject = null;  // null = create mode
        _showNewProjectDialog = true;
    }

    private void CloseNewProjectDialog()
    {
        _showNewProjectDialog = false;
        _editingProject = null;  // reset state
    }

    private async Task HandleProjectSaved(ProjectDto savedProject)
    {
        CloseNewProjectDialog();
        await RefreshListAsync();
    }

    private async Task HandleProjectDeleted(ProjectDto project)
    {
        await RefreshListAsync();
    }

    private async Task RefreshListAsync()
    {
        await _projectList.RefreshAsync();
    }
}