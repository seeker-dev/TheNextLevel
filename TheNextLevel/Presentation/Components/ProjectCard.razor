@using TheNextLevel.Application.DTOs
@using TheNextLevel.Application.Interfaces

@inject IProjectService ProjectService

<div class="project-card">
    <div class="project-header custom-bg">
        <div class="project-header-top">
            <div class="project-icon-wrapper"></div>
            <div class="project-actions">
                <button class="project-menu-btn" @onclick:stopPropagation="true" @onclick="ShowProjectMenu">â‹®</button>
                @if (showMenu)
                {
                    <div class="project-menu">
                        <button class="menu-item" @onclick="OnEditClick">Edit</button>
                        <button class="menu-item menu-item-danger" @onclick="OnDeleteClick">Delete</button>
                    </div>
                }
            </div>
        </div>
        <div class="project-name">@Project?.Name</div>
    </div>
    <div class="project-body">
        <div class="project-description">@Project?.Description</div>
        <div class="project-stats">
            <span class="stat">
                <div class="stat-value">@Project?.Tasks.Count()</div>
                <div class="stat-label">Tasks</div>
            </span>
            <span class="stat">
                <div class="stat-value">@Project?.Tasks.Where(t => t.IsCompleted).Count()</div>
                <div class="stat-label">Completed</div>
            </span>
        </div>
        
        @if (Project?.Tasks != null && Project.Tasks.Any(t => t.IsCompleted))
        {
            <div class="task-preview">
                <div class="task-preview-title">Active Tasks</div>
                <div class="task-preview-list">
                    @foreach (var task in Project.Tasks.Where(t => !t.IsCompleted).Take(3))
                    {
                        <div class="task-preview-item">
                            <input type="checkbox" class="task-preview-checkbox" @onclick:stopPropagation="true" />
                            <span class="task-preview-text">@task.Title</span>
                        </div>
                    }
                </div>
                <div class="task-preview-more">
                    <button class="view-all-tasks" @onclick:stopPropagation="true" @onclick="() => ViewAllTasks(Project.Id)">View All @Project.Tasks.Count() Tasks</button>
                </div>
            </div>
        }
        else
        {
            <div class="empty-project">
                <div class="emoji">ðŸŽ¨</div>
                <p>No tasks yet.</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public ProjectDto? Project { get; set; }

    [Parameter]
    public EventCallback<ProjectDto> OnProjectEdit { get; set; }

    [Parameter]
    public EventCallback<ProjectDto> OnProjectDeleted { get; set; }

    private bool showMenu = false;

    private void ShowProjectMenu()
    {
        showMenu = !showMenu;
    }

    private async Task OnEditClick()
    {
        showMenu = false;
        if (Project != null)
        {
            await OnProjectEdit.InvokeAsync(Project);
        }
    }

    private async Task OnDeleteClick()
    {
        showMenu = false;
        if (Project != null)
        {
            var success = await ProjectService.DeleteProjectAsync(Project.Id);
            if (success)
            {
                await OnProjectDeleted.InvokeAsync(Project);
            }
        }
    }

    private void ViewAllTasks(Guid? projectId)
    {
        // Logic to navigate to all tasks view
    }
}