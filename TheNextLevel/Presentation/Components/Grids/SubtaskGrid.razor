@using Microsoft.AspNetCore.Components.Web.Virtualization
@using TheNextLevel.Application.DTOs
@using TheNextLevel.Presentation.Components.Buttons
@using TheNextLevel.Presentation.Components.Cards
@using TheNextLevel.Presentation.Dialogs

@inject ITaskService TaskService

<div class="add-task-container">
    <button class="filter-btn" @onclick="OpenAddTaskDialog">
        Add New Subtask ‚ûï
    </button>
</div>

<div class="@(_totalCount > 0 ? "task-grid" : "")" tabindex="-1">
    <Virtualize ItemsProvider="LoadSubtasksProvider" @ref="_virtualizeComponent" Context="task">
        <ItemContent>
            <TaskCard 
                Task="task"
                Project="null"
                DeleteEnabled="true"
                EditEnabled="true" />
        </ItemContent>
        <Placeholder>
            <div class="loading-card">Loading...</div>
        </Placeholder>
        <EmptyContent>
            <div class="empty-state">
                @if (ParentTask == null)
                {
                    <div class="empty-icon">üìÅ</div>
                    <p class="empty-title">No parent task selected</p>
                    <p class="empty-subtitle">Please select a parent task to view its subtasks</p>
                }
                else 
                {
                    <div class="empty-icon">üóÇÔ∏è</div>
                    <p class="empty-title">No subtasks found</p>
                    <p class="empty-subtitle">This task has no subtasks</p>
                }
            </div>
        </EmptyContent>
    </Virtualize>
</div>

<NewTaskDialog 
    @ref="newTaskDialog"
    IsVisible="@_showNewTaskDialog"
    OnCancel="CloseNewTaskDialog"
    OnResult="HandleNewTaskResult"
    ParentTaskId="@(ParentTask?.Id)" />

@code
{
    [Parameter]
    public TaskDto? ParentTask { get; set; }

    private NewTaskDialog? newTaskDialog;
    private bool _showNewTaskDialog = false;

    private Virtualize<TaskDto>? _virtualizeComponent;
    private int _totalCount;

    private async ValueTask<ItemsProviderResult<TaskDto>> LoadSubtasksProvider(ItemsProviderRequest request)
    {
        if (ParentTask == null)
        {
            return new ItemsProviderResult<TaskDto>(Array.Empty<TaskDto>(), 0);
        }

        try
        {
            var result = await TaskService.GetSubtasksByParentIdAsync(ParentTask.Id , request.StartIndex, request.Count);
            _totalCount = result.TotalCount;
            return new ItemsProviderResult<TaskDto>(result.Items, result.TotalCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
            return new ItemsProviderResult<TaskDto>(Array.Empty<TaskDto>(), 0);
        }
    }

    private async Task OpenAddTaskDialog()
    {
        _showNewTaskDialog = true;
        StateHasChanged();
    }

    private async Task CloseNewTaskDialog()
    {
        _showNewTaskDialog = false;
        StateHasChanged();
    }

    public async Task RefreshList()
    {
        if (_virtualizeComponent != null)
        {
            await _virtualizeComponent.RefreshDataAsync();
        }
        StateHasChanged();
    }

    private async Task HandleNewTaskResult(TaskDto task)
    {
        _showNewTaskDialog = false;
        await RefreshList();
    }
}