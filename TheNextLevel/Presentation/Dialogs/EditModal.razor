
@inject IMissionService MissionService
@inject IProjectService ProjectService

@if (!_isDialogVisible)
{
    return;
}

<div class="dialog-overlay visible">
    <div class="dialog-container" @onclick:stopPropagation="true">
        <div class="modal-header">
            <div class="modal-badge">
                <h5 class="modal-title">Edit @_itemTypeName</h5>
            </div>
            <button type="button" class="dialog-btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="HideDialog">&times;</button>
        </div>
        <div class="modal-body">
            <input type="text" @bind="itemName" class="form-control" placeholder="Enter @_itemTypeName name" />
            <input type="text" @bind="itemDescription" class="form-control mt-2" placeholder="Enter @_itemTypeName description" />

            @if (Item is TaskDto || Item is ProjectDto)
            {
                <select class="form-select mt-2">
                    <option selected>Select @_parentLabel</option>
                    @if (_isLoading)
                    {
                        <option disabled>Loading @(_parentLabel)s</option>
                    }
                    else if (_parentItems.Count == 0)
                    {
                        <option disabled>No @_parentLabel found</option>
                    }
                    else
                    {
                        @foreach (var item in _parentItems)
                        {
                            <option value="@item.Id">@item.Name</option>
                        }
                    }
                </select>
            }
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="HideDialog">Cancel</button>
            <button type="button" class="btn btn-primary" @onclick="Confirm">Edit</button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public required IItemDto Item { get; set; }

    // Events
    [Parameter]
    public required EventCallback<IItemDto?> OnResult { get; set; }
    [Parameter]
    public required EventCallback OnCancel { get; set; }

    private bool _isLoading = false;
    private List<IItemDto> _parentItems = [];
    private string _parentLabel => Item is TaskDto ? "project" : "mission";
    private string _itemTypeName => Item.GetType().Name[..^3];

    private IItemDto? selectedItem;
    private bool HasSelection => selectedItem is not null;

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;

    // Input binding
    private string itemName = string.Empty;
    private string itemDescription = string.Empty;
    private bool _isDialogVisible = false;
    
    protected override async Task OnParametersSetAsync()
    {
        if (_isDialogVisible)
        {
            itemName = Item.Name;
            itemDescription = Item.Description ?? string.Empty;

            _currentPage = 1;
            _parentItems.Clear();
            await Load();
        }
    }

    public async Task Load()
    {
        _isLoading = true;
        try
        {
            IEnumerable<IItemDto>? items = null;

            if (Item is ProjectDto)
            {
                var result = await MissionService.ListAsync(_currentPage, _pageSize, null);
                items = result?.Items;
                _totalCount = result?.TotalCount ?? 0;
            }
            else if (Item is TaskDto)
            {
                var result = await ProjectService.ListAsync(_currentPage, _pageSize, null);
                items = result?.Items;
                _totalCount = result?.TotalCount ?? 0;
            }

            if (items is not null)
            {
                if (_currentPage == 1)
                    _parentItems = items.ToList();
                else
                    _parentItems.AddRange(items);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task LoadMore()
    {
        _currentPage++;
        await Load();
    }

    private void Select(IItemDto item)
    {
        selectedItem = item;
    }

    private async Task Confirm()
    {
        if (!(HasSelectedParent || HasValidMission))
        {
            // Show validation error (not implemented here)
            return;
        }

        if (Item is MissionDto)
        {
            await EditMission();            
        }
    }

    private async Task EditMission()
    {
        var mission = (MissionDto)Item!;
        var updateRequest = new UpdateMissionDto
        (
            mission.Id,
            itemName,
            itemDescription,
            mission.IsCompleted
        );

        var result = await MissionService.UpdateAsync(updateRequest);
        if (result is not null)
        {
            await OnResult.InvokeAsync(result);
            HideDialog();
        }
    }

    public void ShowDialog()
    {
        _isDialogVisible = true;
    }
    public void HideDialog()
    {
        _isDialogVisible = false;
    }

    private bool HasSelectedParent => (Item is ProjectDto || Item is TaskDto) && selectedItem is not null;
    private bool HasValidMission => Item is MissionDto && !string.IsNullOrWhiteSpace(itemName);
}