@using Microsoft.AspNetCore.Components.Web.Virtualization
@using TheNextLevel.Application.DTOs
@using TheNextLevel.Presentation.Components.Buttons
@using TheNextLevel.Presentation.Components.Cards
@using TheNextLevel.Presentation.Dialogs

@inject ITaskService TaskService

<div class="filter-controls">
    <button class="filter-btn @(_showCompleted ? "" : "active")" @onclick="ShowPending">
        Pending
    </button>
    <button class="filter-btn @(_showCompleted ? "active" : "")" @onclick="ShowCompleted">
        Completed
    </button>
</div>

<div class="@(_totalCount > 0 ? "task-grid" : "")" tabindex="-1">
        <Virtualize ItemsProvider="LoadTasksProvider" @ref="_virtualizeComponent" Context="task">
            <ItemContent>
                <TaskCard
                    Task="task"
                    Project="Project"
                    EditEnabled="EditEnabled"
                    DeleteEnabled="DeleteEnabled" />
            </ItemContent>
            <Placeholder>
                <div class="loading-card">Loading...</div>
            </Placeholder>
            <EmptyContent>
                <div class="empty-state">
                    @if (Project == null)
                    {
                        <div class="empty-icon">üìÅ</div>
                        <p class="empty-title">No project selected</p>
                        <p class="empty-subtitle">Please select a project to view its tasks</p>
                    }
                    else if (_showCompleted)
                    {
                        <div class="empty-icon">‚úì</div>
                        <p class="empty-title">No completed tasks yet</p>
                        <p class="empty-subtitle">Tasks you complete will appear here</p>
                    }
                    else 
                    {
                        <div class="empty-icon">üéØ</div>
                        <p class="empty-title">No pending tasks</p>
                        <p class="empty-subtitle">You're all caught up! Time to add something new?</p>
                    }
                </div>
            </EmptyContent>
        </Virtualize>
</div>
@code {
    [Parameter]
    public ProjectDto? Project { get; set; }

    [Parameter]
    public bool EditEnabled { get; set; }

    [Parameter]
    public bool DeleteEnabled { get; set; }

    private Virtualize<TaskDto>? _virtualizeComponent;
    private bool _showCompleted = false;
    private int _totalCount = 0;

    private async ValueTask<ItemsProviderResult<TaskDto>> LoadTasksProvider(ItemsProviderRequest request)
    {
        if (Project == null)
        {
            return new ItemsProviderResult<TaskDto>(
                Array.Empty<TaskDto>(),
                0);
        }

        try
        {
            var pagedResult = await TaskService.GetTasksByProjectPagedAsync(
                projectId: Project.Id,
                skip: request.StartIndex,
                take: request.Count,
                isCompleted: _showCompleted);

            _totalCount = pagedResult.TotalCount;

            return new ItemsProviderResult<TaskDto>(
                pagedResult.Items,
                pagedResult.TotalCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tasks: {ex.Message}");
            return new ItemsProviderResult<TaskDto>(
                Array.Empty<TaskDto>(),
                0);
        }
    }

    private async Task ShowPending()
    {
        _showCompleted = false;
        await RefreshList();
    }

    private async Task ShowCompleted()
    {
        _showCompleted = true;
        await RefreshList();
    }

    public async Task RefreshList()
    {
        if (_virtualizeComponent != null)
        {
            await _virtualizeComponent.RefreshDataAsync();
        }
        StateHasChanged();
    }
}