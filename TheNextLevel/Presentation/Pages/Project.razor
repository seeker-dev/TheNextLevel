@page "/project/{Id:int}"

@using Microsoft.JSInterop
@using TheNextLevel.Application.DTOs
@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Presentation.Components.Cards
@using TheNextLevel.Presentation.Components.Grids
@using TheNextLevel.Presentation.Dialogs
@using TheNextLevel.Presentation.Components.Buttons

@inject IProjectService ProjectService
@inject NavigationManager Navigation
@inject ITaskService TaskService
@inject IJSRuntime JSRuntime

<main class="main-content">
    <div class="project-page-header custom-bg">
        <button class="back-button" @onclick="NavigateBack">‚Üê</button>
        @if (_isLoading)
        {
            <p class="loading-text">Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_project != null)
        {
            <h1 class="project-page-title">@_project.Name</h1>

            <div class="project-action-buttons">
                <button class="action-btn action-btn-primary" @onclick="ShowEditDialog">‚úèÔ∏è</button>
                <button title="Delete Project" class="action-btn action-btn-danger" @onclick="ShowDeleteDialog">üóëÔ∏è</button>
            </div>
        }
    </div>
    <div class="description-section">
        @if (_isLoading)
        {
            <p class="loading-text">Loading project description...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_project != null)
        {
            <h3>Description</h3>
            <p>@_project.Description</p>
        }
    </div>
    <div class="tasks-section">
        @if (_isLoading)
        {
            <p class="loading-text">Loading tasks...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_project != null)
        {
            <div class="tasks-section-header">
                <button class="filter-btn" @onclick="OpenCreateTask">Add New Task ‚ûï</button>
            </div>
            <TaskGrid
                @ref="_taskGrid"
                Project="@_project"
                OnEditRequested="HandleEditTask"
                OnDeleteRequested="HandleDeleteTask" />
        }
    </div>
</main>

<NewProjectDialog
    IsVisible="@_isEditDialogVisible"
    ExistingProject="@_project"
    OnCancel="CloseEditDialog"
    OnResult="HandleProjectUpdated" />

<ConfirmDeleteDialog
    IsVisible="@_isDeleteDialogVisible"
    ItemName="@_project?.Name"
    ItemType="project"
    OnCancel="() => _isDeleteDialogVisible = false"
    OnConfirm="OnDeleteConfirmed" />

<CreateModal
    IsVisible="@_showCreateTaskModal"
    ItemType="ModalType.Task"
    OnResult="HandleTaskCreated"
    OnCancel="CloseCreateTask" />

<EditTaskDialog
    Task="@_selectedTask"
    IsVisible="@_showEditTaskDialog"
    OnClose="CloseEditTask"
    OnTaskSaved="HandleTaskUpdated" />

<ConfirmDeleteDialog
    IsVisible="@_showDeleteTaskDialog"
    OnCancel="CloseDeleteTask"
    OnConfirm="HandleDeleteTaskConfirmed"
    ItemName="@(_selectedTask?.Name ?? "this task")"
    ItemType="task" />

@code {
    [Parameter]
    public int Id { get; set; }

    private bool _isLoading = true;
    private bool _isDeleteDialogVisible = false;
    private bool _isEditDialogVisible = false;
    private ProjectDto? _project;
    private string? _errorMessage = null;

    private TaskGrid? _taskGrid;
    private TaskDto? _selectedTask;
    private bool _showCreateTaskModal;
    private bool _showEditTaskDialog;
    private bool _showDeleteTaskDialog;

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
    }

    private async Task LoadProject()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _project = await ProjectService.GetByIdAsync(Id);

            if (_project == null)
            {
                _errorMessage = "Project could not be found.";
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading project: {ex.Message}");
            _errorMessage = "An error occurred while loading the project.";
            _isLoading = false;
            StateHasChanged();
        }
    }

    // === PROJECT CRUD ===
    private void ShowDeleteDialog() => _isDeleteDialogVisible = true;
    private void ShowEditDialog() => _isEditDialogVisible = true;
    private void CloseEditDialog() => _isEditDialogVisible = false;

    private async Task OnDeleteConfirmed()
    {
        if (_project != null)
        {
            try
            {
                await ProjectService.DeleteAsync(_project.Id);
                Navigation.NavigateTo("/");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting project: {ex.Message}");
                _errorMessage = "An error occurred while deleting the project.";
            }
        }

        _isDeleteDialogVisible = false;
    }

    private async Task HandleProjectUpdated(ProjectDto updatedProject)
    {
        _project = updatedProject;
        CloseEditDialog();
        StateHasChanged();
    }

    // === TASK CRUD ===
    private void OpenCreateTask() => _showCreateTaskModal = true;
    private void CloseCreateTask() => _showCreateTaskModal = false;

    private async Task HandleTaskCreated(IItemDto? task)
    {
        _showCreateTaskModal = false;
        if (_taskGrid != null) await _taskGrid.RefreshList();
    }

    private void HandleEditTask(TaskDto task)
    {
        _selectedTask = task;
        _showEditTaskDialog = true;
    }

    private void CloseEditTask()
    {
        _showEditTaskDialog = false;
        _selectedTask = null;
    }

    private async Task HandleTaskUpdated(TaskDto task)
    {
        CloseEditTask();
        if (_taskGrid != null) await _taskGrid.RefreshList();
    }

    private void HandleDeleteTask(TaskDto task)
    {
        _selectedTask = task;
        _showDeleteTaskDialog = true;
    }

    private void CloseDeleteTask()
    {
        _showDeleteTaskDialog = false;
        _selectedTask = null;
    }

    private async Task HandleDeleteTaskConfirmed()
    {
        if (_selectedTask != null)
        {
            await TaskService.DeleteAsync(_selectedTask.Id);
        }
        CloseDeleteTask();
        if (_taskGrid != null) await _taskGrid.RefreshList();
    }

    private async Task NavigateBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }
}
