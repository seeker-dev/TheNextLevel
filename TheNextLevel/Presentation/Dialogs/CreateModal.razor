@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Application.DTOs

@inject IMissionService MissionService
@inject IProjectService ProjectService
@inject ITaskService TaskService

@if (IsVisible)
{
<div class="dialog-overlay visible">
    <div class="dialog-container" @onclick:stopPropagation="true">
        <div class="modal-header">
            <div class="modal-badge">
                <h5 class="modal-title">Create @ItemType</h5>
            </div>
            <button type="button" class="dialog-btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="Cancel">&times;</button>
        </div>

        <div class="modal-body">
            <input type="text" @bind="itemName" class="form-control" placeholder="Enter @ItemType name" />
            <input type="text" @bind="itemDescription" class="form-control mt-2" placeholder="Enter @ItemType description" />

            @if (ItemType == ModalType.Task || ItemType == ModalType.Project)
            {
                <select class="form-select mt-2">
                    <option selected>Select @_parentLabel</option>
                    @if (_isLoading)
                    {
                        <option disabled>Loading @(_parentLabel)s</option>
                    }
                    else if (_parentItems.Count == 0)
                    {
                        <option disabled>No @_parentLabel found</option>
                    }
                    else
                    {
                        @foreach (var item in _parentItems)
                        {
                            <option value="@item.Id" @onclick="() => Select(item)">@item.Name</option>
                        }
                    }
                </select>
            }
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="Cancel">Cancel</button>
            <button type="button" class="btn btn-primary" @onclick="Confirm">Create</button>
        </div>
    </div>
</div>
}
@code {
    [Parameter]
    public required bool IsVisible { get; set; }
    [Parameter]
    public required ModalType ItemType { get; set; }

    // Events
    [Parameter]
    public required EventCallback<IItemDto?> OnResult { get; set; }
    [Parameter]
    public required EventCallback OnCancel { get; set; }

    private bool _isLoading = false;
    private List<IItemDto> _parentItems = [];
    private string _parentLabel => ItemType == ModalType.Task ? "project" : "mission";
    private IItemDto? selectedParent;
    private bool HasSelection => selectedParent is not null;

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;

    // Input binding
    private string itemName = string.Empty;
    private string itemDescription = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            _currentPage = 1;
            _parentItems.Clear();
            await Load();
        }
    }

    public async Task Load()
    {
        _isLoading = true;
        try
        {
            IEnumerable<IItemDto>? items = null;

            if (ItemType == ModalType.Project)
            {
                var result = await MissionService.ListAsync(_currentPage, _pageSize);
                items = result?.Items;
                _totalCount = result?.TotalCount ?? 0;
            }
            else if (ItemType == ModalType.Task)
            {
                var result = await ProjectService.ListAsync(_currentPage, _pageSize);
                items = result?.Items;
                _totalCount = result?.TotalCount ?? 0;
            }

            if (items is not null)
            {
                if (_currentPage == 1)
                    _parentItems = items.ToList();
                else
                    _parentItems.AddRange(items);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMore()
    {
        _currentPage++;
        await Load();
    }

    private void Select(IItemDto item)
    {
        selectedParent = item;
    }

    private async Task Confirm()
    {
        if (!(HasSelectedParent || HasValidMission))
        {
            // Show validation error (not implemented here)
            return;
        }

        if (ItemType == ModalType.Mission)
        {
            await CreateMission();            
        }
        else if (ItemType == ModalType.Project)
        {
            await CreateProject();
        }
        else if (ItemType == ModalType.Task)
        {
            await CreateTask();
        }
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    private async Task CreateMission()
    {
        var createRequest = new CreateMissionDto(itemName.Trim(), itemDescription.Trim());
        var newMission = await MissionService.CreateAsync(createRequest);
        var newMissionCreated = await MissionService.GetByIdAsync(newMission.Id) != null;
        if (newMissionCreated)
        {
            await OnResult.InvokeAsync(newMission);
        }
    }

    private async Task CreateProject()
    {
        if (selectedParent is null)
        {
            // Show validation error (not implemented here)
            return;
        }

        var createRequest = new CreateProjectDto(selectedParent.Id, itemName.Trim(), itemDescription.Trim());
        var newProject = await ProjectService.CreateAsync(createRequest);
        var newProjectCreated = await ProjectService.GetByIdAsync(newProject.Id) != null;
        if (newProjectCreated)
        {
            await OnResult.InvokeAsync(newProject);
        }
    }

    private async Task CreateTask()
    {
        if (selectedParent is null)
        {
            // Show validation error (not implemented here)
            return;
        }

        var createRequest = new CreateTaskRequest(selectedParent.Id, itemName.Trim(), itemDescription.Trim());
        var task = await TaskService.CreateAsync(createRequest);
        var newTask = await TaskService.GetByIdAsync(task.Id);
        if (newTask is not null)
        {
            await OnResult.InvokeAsync(newTask);
        }
    }

    private bool HasSelectedParent => (ItemType == ModalType.Project || ItemType == ModalType.Task) && selectedParent is not null;
    private bool HasValidMission => ItemType == ModalType.Mission && !string.IsNullOrWhiteSpace(itemName);
}
