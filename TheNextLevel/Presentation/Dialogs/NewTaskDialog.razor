@* Debug: IsVisible = @IsVisible *@
@if (IsVisible)
{
    <div class="dialog-overlay visible" @onclick="HandleOverlayClick">
        <div class="dialog-container" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h2 class="dialog-title">@DialogTitle</h2>
                <button class="dialog-btn-close" @onclick="Cancel">√ó</button>
            </div>

            <div class="dialog-body">
                <div class="dialog-form-section">
                    <div class="dialog-section-title">
                        <span class="dialog-section-icon">üìù</span>
                        Task Details
                    </div>

                    <div class="dialog-form-group">
                        <label class="dialog-form-label">Title</label>
                        <input class="dialog-form-input" @bind="taskTitle" placeholder="Enter task title..." />
                    </div>

                    <div class="dialog-form-group">
                        <label class="dialog-form-label">Description</label>
                        <textarea class="dialog-form-input dialog-form-textarea" @bind="taskDescription" placeholder="Add task description..."></textarea>
                    </div>
                </div>
            </div>

            <div class="dialog-footer">
                <div class="dialog-footer-left">
                    <span class="dialog-motivation-text">Every task completed is a step forward! üöÄ</span>
                </div>
                <div class="dialog-footer-right">
                    <button class="dialog-btn dialog-btn-cancel" @onclick="Cancel">Cancel</button>
                    <button class="dialog-btn dialog-btn-primary" @onclick="Save">@SaveButtonText</button>
                </div>
            </div>
        </div>
    </div>
}

@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Application.DTOs
@inject ITaskService TaskService

@code {
	[Parameter]
	public bool IsVisible { get; set; }

	[Parameter]
	public EventCallback<TaskDto> OnResult { get; set; }

	[Parameter]
	public EventCallback OnCancel { get; set; }

	[Parameter]
	public TaskDto? ExistingTask { get; set; }

	private string taskTitle = string.Empty;
	private string taskDescription = string.Empty;

	// Computed properties for mode-aware behavior
	private bool IsEditMode => ExistingTask != null;
	private string DialogTitle => IsEditMode ? "Edit Task" : "Create New Task";
	private string SaveButtonText => IsEditMode ? "Save Changes" : "Save Task";

	protected override void OnParametersSet()
	{
		if (IsVisible)
		{
			if (IsEditMode && ExistingTask != null)
			{
				// Populate form with existing task data
				taskTitle = ExistingTask.Name;
				taskDescription = ExistingTask.Description ?? string.Empty;
			}
			else
			{
				// Reset form when creating new task
				taskTitle = string.Empty;
				taskDescription = string.Empty;
			}
		}
	}

	private async Task Cancel()
	{
		await OnCancel.InvokeAsync();
	}

	private async Task HandleOverlayClick()
	{
		await Cancel();
	}

	private async Task Save()
	{
		if (!string.IsNullOrWhiteSpace(taskTitle))
		{
			TaskDto? resultTask = null;

			if (IsEditMode && ExistingTask != null)
			{
				// Edit mode: update existing task
				var updateRequest = new UpdateTaskRequest(
					taskTitle.Trim(),
					taskDescription?.Trim() ?? string.Empty
				);
				await TaskService.UpdateTaskAsync(ExistingTask.Id, updateRequest);
				resultTask = await TaskService.GetTaskByIdAsync(ExistingTask.Id);
			}
			else
			{
				// Create mode: create new task
				var createRequest = new CreateTaskRequest(
					taskTitle.Trim(),
					taskDescription?.Trim() ?? string.Empty
				);

				var taskId = await TaskService.CreateTaskAsync(createRequest);
				resultTask = await TaskService.GetTaskByIdAsync(taskId);
			}

			if (resultTask != null)
			{
				await OnResult.InvokeAsync(resultTask);
			}

			// Reset form after saving
			taskTitle = string.Empty;
			taskDescription = string.Empty;
		}
	}
}
