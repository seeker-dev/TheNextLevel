@page "/task/{Id:int}"
@using TheNextLevel.Application.DTOs
@using TheNextLevel.Presentation.Components.Grids
@using TheNextLevel.Presentation.Dialogs
@using System.Text.Json

@inject ITaskService TaskService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<main class="main-content">
    <div class="task-detail-page-header sunrise-bg">
        <button class="back-button" @onclick="NavigateBack">←</button>
        @if (_isLoading)
        {
            <p class="loading-text">Loading...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_task != null)
        {
            <h1 class="task-detail-page-title">@_task.Name</h1>
            <h2 class="task-detail-page-subtitle">Project: @(_project?.Name ?? "Unknown")</h2>
        }
    </div>
    <div class="task-detail-section">
        @if (_isLoading)
        {
            <p class="loading-text">Loading task details...</p>
        }
        else if (_errorMessage != null)
        {
            <p class="error-message">@_errorMessage</p>
        }
        else if (_task != null)
        {
            <div class="task-detail-card">
                <div class="description-section">
                    <h3>Description</h3>
                    <p>@_task.Description</p>
                </div>

                <div class="subtasks-section-header">
                    <button class="filter-btn" @onclick="OpenCreateSubtask">Add New Subtask ➕</button>
                </div>
                <SubtaskGrid
                    @ref="_subtaskGrid"
                    ParentTask="_task"
                    OnEditRequested="HandleEditSubtask"
                    OnDeleteRequested="HandleDeleteSubtask" />
            </div>
        }
    </div>
</main>

<NewTaskDialog
    IsVisible="@_showNewSubtaskDialog"
    OnCancel="CloseNewSubtask"
    OnResult="HandleSubtaskCreated"
    ParentTaskId="@_task?.Id" />

<EditTaskDialog
    Task="@_selectedSubtask"
    IsVisible="@_showEditSubtaskDialog"
    OnClose="CloseEditSubtask"
    OnTaskSaved="HandleSubtaskUpdated" />

<ConfirmDeleteDialog
    IsVisible="@_showDeleteSubtaskDialog"
    OnCancel="CloseDeleteSubtask"
    OnConfirm="HandleDeleteSubtaskConfirmed"
    ItemName="@(_selectedSubtask?.Name ?? "this subtask")"
    ItemType="subtask" />

@code {
    [Parameter]
    public int Id { get; set; }

    private TaskDto? _task;
    private ProjectDto? _project;
    private bool _isLoading = true;
    private string? _errorMessage = null;

    private SubtaskGrid? _subtaskGrid;
    private TaskDto? _selectedSubtask;
    private bool _showNewSubtaskDialog;
    private bool _showEditSubtaskDialog;
    private bool _showDeleteSubtaskDialog;

    protected override async Task OnInitializedAsync()
    {
        var projectJson = Navigation.HistoryEntryState as string;
        if (!string.IsNullOrEmpty(projectJson))
        {
            _project = JsonSerializer.Deserialize<ProjectDto>(projectJson);
        }
        await LoadTask();
    }

    private async Task NavigateBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }

    private async Task LoadTask()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _task = await TaskService.GetByIdAsync(Id);

            if (_task == null)
            {
                _errorMessage = "Task could not be found.";
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading task: {ex.Message}");
            _errorMessage = "An error occurred while loading the task.";
            _isLoading = false;
            StateHasChanged();
        }
    }

    // === SUBTASK CRUD ===
    private void OpenCreateSubtask() => _showNewSubtaskDialog = true;
    private void CloseNewSubtask() => _showNewSubtaskDialog = false;

    private async Task HandleSubtaskCreated(TaskDto subtask)
    {
        _showNewSubtaskDialog = false;
        if (_subtaskGrid != null) await _subtaskGrid.RefreshList();
    }

    private void HandleEditSubtask(TaskDto subtask)
    {
        _selectedSubtask = subtask;
        _showEditSubtaskDialog = true;
    }

    private void CloseEditSubtask()
    {
        _showEditSubtaskDialog = false;
        _selectedSubtask = null;
    }

    private async Task HandleSubtaskUpdated(TaskDto subtask)
    {
        CloseEditSubtask();
        if (_subtaskGrid != null) await _subtaskGrid.RefreshList();
    }

    private void HandleDeleteSubtask(TaskDto subtask)
    {
        _selectedSubtask = subtask;
        _showDeleteSubtaskDialog = true;
    }

    private void CloseDeleteSubtask()
    {
        _showDeleteSubtaskDialog = false;
        _selectedSubtask = null;
    }

    private async Task HandleDeleteSubtaskConfirmed()
    {
        if (_selectedSubtask != null)
        {
            await TaskService.DeleteAsync(_selectedSubtask.Id);
        }
        CloseDeleteSubtask();
        if (_subtaskGrid != null) await _subtaskGrid.RefreshList();
    }
}
