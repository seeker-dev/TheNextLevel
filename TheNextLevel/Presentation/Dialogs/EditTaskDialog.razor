@using TheNextLevel.Application.Interfaces
@using TheNextLevel.Application.DTOs
@inject IProjectService ProjectService
@inject ITaskService TaskService

@if (!IsVisible)
{
    return;
}
<div class="dialog-overlay visible">
    <div class="dialog-container" @onclick:stopPropagation="true">
        <div class="dialog-header">
            <h3 class="dialog-title">
                <span class="edit-icon">✏️</span>
                Edit Task
            </h3>
            <button class="dialog-btn-close" @onclick="OnCancelClick" aria-label="Close">&times;</button>
        </div>
    </div>
    <div class="dialog-body">
        <div class="dialog-form-group">
            <label class="dialog-form-label">Title</label>
            <input class="dialog-form-input" @bind="taskTitle" placeholder="Enter task title..." />
        </div>
        <div class="dialog-form-group">
            <label class="dialog-form-label">Description</label>
            <textarea class="dialog-form-input dialog-form-textarea" @bind="taskDescription" placeholder="Add task description..."></textarea>
        </div>
        @if (Task?.ParentTaskId != null)
        {
            <div class="dialog-info-message">
                This task is a subtask and cannot be assigned to a project directly.
            </div>
        }
        else
        {
            <div class="dialog-form-group">
                <label class="dialog-form-label">Project</label>
                <button type="button" class="dialog-form-input project-selector-btn" @onclick="OpenProjectPicker">
                    @if (selectedProjectDto != null)
                    {
                        <span>@selectedProjectDto.Name</span>
                    }
                    else
                    {
                        <span class="placeholder">No Project</span>
                    }
                    <span class="selector-arrow">▼</span>
                </button>
            </div>
        }
        <div class="dialog-actions">
            <button class="dialog-btn dialog-btn-secondary" @onclick="OnCancelClick">Cancel</button>
            <button class="dialog-btn dialog-btn-primary" @onclick="OnSaveChangesClick">Save Changes</button>
        </div>
    </div>
</div>

@if (showDiscardConfirmation)
{
    <div class="dialog-overlay visible">
        <div class="dialog-container" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h3 class="dialog-title">Discard Changes?</h3>
            </div>
            <div class="dialog-body">
                <p>You have unsaved changes. Are you sure you want to discard them?</p>
                <div class="dialog-actions">
                    <button class="dialog-btn dialog-btn-secondary" @onclick="OnDiscardCancel">Keep Editing</button>
                    <button class="dialog-btn dialog-btn-danger" @onclick="OnDiscardConfirm">Discard</button>
                </div>
            </div>
        </div>
    </div>
}

<ProjectPickerDialog
    IsVisible="showProjectPicker"
    SelectedProjectId="selectedProjectId"
    AllowNoProject="true"
    OnResult="HandleProjectSelected"
    OnCancel="CloseProjectPicker" />

@code
{
    [Parameter]
    public TaskDto? Task { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<TaskDto> OnTaskSaved { get; set; }

    private string taskTitle = string.Empty;
    private string taskDescription = string.Empty;

    private int? selectedProjectId;
    private ProjectDto? selectedProjectDto;
    private bool showDiscardConfirmation = false;
    private bool showProjectPicker = false;

    bool nameChanged => Task?.Name != taskTitle;
    bool descriptionChanged => Task?.Description != taskDescription;
    bool projectChanged => Task?.ProjectId != selectedProjectId;
    bool hasUnsavedChanges => nameChanged || descriptionChanged || projectChanged;

    protected override async Task OnParametersSetAsync()
    {
        if (Task != null)
        {
            taskTitle = Task.Name;
            taskDescription = Task.Description ?? string.Empty;
            selectedProjectId = Task.ProjectId;

            if (selectedProjectId.HasValue)
            {
                selectedProjectDto = await ProjectService.GetByIdAsync(selectedProjectId.Value);
            }
            else
            {
                selectedProjectDto = null;
            }
        }
    }

    private void OpenProjectPicker()
    {
        showProjectPicker = true;
    }

    private void CloseProjectPicker()
    {
        showProjectPicker = false;
    }

    private async Task HandleProjectSelected(ProjectDto? project)
    {
        selectedProjectDto = project;
        selectedProjectId = project?.Id;
        showProjectPicker = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCancelClick()
    {
        if (hasUnsavedChanges)
        {
            showDiscardConfirmation = true;
            await InvokeAsync(StateHasChanged);
            return;
        }

        await CloseDialog();
    }

    private async Task OnDiscardConfirm()
    {
        showDiscardConfirmation = false;
        await CloseDialog();
    }

    private async Task OnDiscardCancel()
    {
        showDiscardConfirmation = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseDialog()
    {
        IsVisible = false;
        await OnClose.InvokeAsync();
    }

    private async Task OnSaveChangesClick()
    {
        await SaveTaskChangesAsync();
        if (Task != null)
        {
            var updatedTask = await TaskService.GetByIdAsync(Task.Id);
            await OnTaskSaved.InvokeAsync(updatedTask);
        }
        await CloseDialog();
    }

    private async Task SaveTaskChangesAsync()
    {
        // if task name changed, update it
        if (nameChanged || descriptionChanged)
        {
            await TaskService.UpdateAsync(Task!.Id, 
                new UpdateTaskRequest(taskTitle, taskDescription, Task!.IsCompleted, selectedProjectId.Value));
        }

        // if project changed, update it
        if (projectChanged)
        {
            await TaskService.MoveAsync(Task!.Id, selectedProjectId.Value);
        }
    }
}